<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Campus Connect QR Check In</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="styles.css" />
    <!-- Apple font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap" />
</head>
<body>
    <div class="container my-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h1 class="card-title text-center mb-4">Campus Connect QR Check In</h1>
                <div id="my-qr-reader" class="mb-3"></div>
            </div>
        </div>
    </div>

    <button id="modeToggle" class="btn btn-light btn-sm rounded-pill shadow-sm position-fixed bottom-0 end-0 m-3" title="Toggle Dark/Light Mode" style="z-index: 1050; border: 1px solid #d1d1d6;">
        <i class="bi bi-moon-fill" id="modeIcon" style="color: #1d1d1f;"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="script.js"></script>

    <script>
        // Dark/Light mode toggle
        const modeToggle = document.getElementById('modeToggle');
        const modeIcon = document.getElementById('modeIcon');
        const currentMode = localStorage.getItem('mode') || 'dark';

        function applyMode(mode) {
            if (mode === 'light') {
                document.body.classList.add('light-mode');
                modeIcon.classList.remove('bi-moon-fill');
                modeIcon.classList.add('bi-sun-fill');
            } else {
                document.body.classList.remove('light-mode');
                modeIcon.classList.remove('bi-sun-fill');
                modeIcon.classList.add('bi-moon-fill');
            }
        }

        applyMode(currentMode);

        modeToggle.addEventListener('click', () => {
            const newMode = document.body.classList.contains('light-mode') ? 'dark' : 'light';
            applyMode(newMode);
            localStorage.setItem('mode', newMode);
        });
    </script>

    <script>
        // QR code scanner initialization and callback
        function domReady(fn) {
            if (
                document.readyState === "complete" ||
                document.readyState === "interactive"
            ) {
                setTimeout(fn, 1000);
            } else {
                document.addEventListener("DOMContentLoaded", fn);
            }
        }

            domReady(function () {
                function onScanSuccess(decodedText, decodedResult) {
                    // Parse QR code data (assuming JSON format)
                    let registrationData;
                    try {
                        registrationData = JSON.parse(decodedText);
                    } catch (e) {
                        registrationData = { id: decodedText, name: "Unknown", college: "Unknown", event: "Unknown" };
                    }

                    // Show readable alert info
                    alert(`QR Code Scanned:\nID: ${registrationData.id || ''}\nName: ${registrationData.name || ''}\nCollege: ${registrationData.college || ''}\nEvent: ${registrationData.event || ''}`);

                    // Display scanned info in table
                    const tableBody = document.getElementById('scannedDataBody');
                    if (tableBody) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${registrationData.id || ''}</td>
                            <td>${registrationData.name || ''}</td>
                            <td>${registrationData.college || ''}</td>
                            <td>${registrationData.event || ''}</td>
                            <td>${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        `;
                        tableBody.prepend(newRow);
                    }

                    // Save to localStorage attendanceData
                    const attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
                    const exists = attendanceData.some(entry => entry.regId === registrationData.id);
                    if (!exists) {
                        attendanceData.push({
                            regId: registrationData.id,
                            name: registrationData.name,
                            collegeName: registrationData.college,
                            eventName: registrationData.event,
                            checkInTime: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        });
                        localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
                    }
                }

                const config = {
                    fps: 10,
                    qrbox: 250,
                    rememberLastUsedCamera: true,
                    supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA, Html5QrcodeScanType.SCAN_TYPE_FILE]
                };

                let htmlscanner = new Html5QrcodeScanner(
                    "my-qr-reader",
                    config,
                    /* verbose= */ false
                );
                try {
                    // Pass config as cameraIdOrConfig parameter to render
                    htmlscanner.render(
                        { fps: 10, qrbox: 250, rememberLastUsedCamera: true, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA, Html5QrcodeScanType.SCAN_TYPE_FILE] },
                        onScanSuccess
                    );
                } catch (error) {
                    console.error("Error starting QR code scanner:", error);
                    alert("Error starting QR code scanner: " + error.message);
                }
            });
    </script>
</body>
</html>
